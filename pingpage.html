<!doctype html>

<html>
  <head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <meta charset = "utf-8">
    <title>Calculate Latency Using WebSockets</title>
    <style>
      p {
        display: inline-block;
      }
      .buttonload {
        background-color: #cec1e7;
        border: none; /* Remove borders */
        color: black; /* White text */
        padding: 12px 24px; /* Some padding */
        font-size: 16px; /* Set a font-size */
      }
      .fa {
        margin-left: -12px;
        margin-right: 8px;
      }
    </style>

  </head>

  <body>
    <h2>Calculate Latency Using WebSockets and Measure ICMP latency</h2>
    <p>Experiment UUID: &ensp;</p><p id="uuid"></p><br>
    <p>Your IP: &ensp;</p><p id="ip"></p> <br>
    <p>All WebSocket measurements: &ensp;</p><p id="values"></p> <br>
    <p>Median WS latency: &ensp;</p><p id="data"></p> <br>
    <p>ICMP ping statistics: We conducted measaurements to your IP. Average RTT: &ensp;</p> <p id="icmp"></p> <br>
    <div id="loading">
      <button class="buttonload">
        <i class="fa fa-spinner fa-spin"></i>Running Zero Trace Measurements, do not close this window (approx 2 minutes)...
      </button>
    </div>
      <script>
      setTimeout(() => {
        const loading = document.getElementById("loading");
        loading.style.display = "none";
      }, 120000);

     function median(values){
            if (values.length ===0) return 0;
            values.sort(function(a,b){
              return a-b;
            });
            var half = Math.floor(values.length / 2);
            if (values.length % 2)
              return values[half];
            return (values[half - 1] + values[half]) / 2.0;
          }
      function roundToTwo(num) {    
        return +(Math.round(num + "e+2")  + "e-2");
      }

      function getLatencyWebSocket() {
        return new Promise(function (resolve, reject) {
          var ipaddress = {{ .IPaddr }};
          var uuid = {{ .UUID }};
          // Create a Web Socket
          const socket = new WebSocket('wss://test.reethika.info/echo');
          socket.onerror = function (err) {
            reject(err.toString());
          }

          var messages = [];
          const latencies = [];
          var statsSent = false;

          socket.onopen = function () {
            socket.send(JSON.stringify({
              type: 'ws-latency',
              ts: roundToTwo(performance.now()),
            }));
          }

          socket.onmessage = function (event) {
            messages.push(JSON.parse(event.data));
            if (messages.length <= 5) {
              socket.send(JSON.stringify({
                type: 'ws-latency',
                ts: roundToTwo(performance.now()),
              }));
            } else {
              for (let i = 0; i < messages.length - 1; i++) {
                latencies.push(roundToTwo(messages[i+1].ts - messages[i].ts));
              }
              if (statsSent == false) {
              const datetimeutc = new Date().toISOString();
              socket.send(JSON.stringify({
                UUID: uuid,
                IP: ipaddress,
                Timestamp: datetimeutc,
                latencies: latencies,
              }));
              statsSent = true;
            }
              resolve(latencies);
            }
          }
        });
        }
    const keepAlivePktInterval = 1000;
    const keepAliveTimePeriodms = 600000;
    function makeAnotherWs() {
          var ipaddress = {{ .IPaddr }};
          var uuid = {{ .UUID }};
          const webSocketAddr = 'wss://test.reethika.info/trace?uuid={{ .UUID }}';
          // Create a Web Socket
          const socket = new WebSocket(webSocketAddr);
          var startTime = new Date().getTime(); 
          const intervalId = setInterval(() => {
            if(new Date().getTime() - startTime > keepAliveTimePeriodms){
              clearInterval(intervalId);
              return;
            }
            socket.send("Keep alive");
          }, keepAlivePktInterval);

          socket.onerror = function (err) {
            reject(err.toString());
          }
          socket.onopen = function () {
          }
    }

	   makeAnotherWs();

     getLatencyWebSocket().then((latencies) => {
        document.getElementById('uuid').innerHTML = {{ .UUID }};
        document.getElementById('ip').innerHTML = {{ .IPaddr }};
        document.getElementById('values').innerHTML = latencies;
        document.getElementById('data').innerHTML = median(latencies);
        document.getElementById('icmp').innerHTML = {{ .AvgIcmpStat }};
      });
    </script>
  </body>
</html>
